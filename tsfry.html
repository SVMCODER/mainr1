<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Craft | Enterprise Dashboard</title>
    
    <!-- Firebase Configuration -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- jsPDF for Invoices -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Status Badges */
        .status-badge {
            @apply px-2 py-1 rounded-full text-xs font-bold uppercase;
        }
        .status-open { @apply bg-blue-100 text-blue-800; }
        .status-progress { @apply bg-yellow-100 text-yellow-800; }
        .status-review { @apply bg-purple-100 text-purple-800; }
        .status-completed { @apply bg-green-100 text-green-800; }
        .status-closed { @apply bg-gray-100 text-gray-800; }
        .status-paid { @apply bg-green-100 text-green-800; }
        .status-pending { @apply bg-red-100 text-red-800; }
        .status-verified { @apply bg-indigo-100 text-indigo-800; }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        /* Glass effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* File upload dropzone */
        .dropzone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .dropzone.dragover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        /* Chat bubbles */
        .chat-bubble {
            @apply max-w-[70%] rounded-lg p-3 text-sm;
        }
        .chat-bubble.sent {
            @apply bg-blue-600 text-white rounded-br-none ml-auto;
        }
        .chat-bubble.received {
            @apply bg-gray-100 text-gray-800 rounded-bl-none;
        }
        
        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

<!-- Loading Screen -->
<div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
    <div class="loader mb-4"></div>
    <p class="text-gray-600">Loading Research Craft Dashboard...</p>
</div>

<!-- Auth Screen -->
<div id="auth-screen" class="hidden fixed inset-0 bg-gradient-to-br from-blue-50 to-indigo-50 z-40 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Research Craft</h1>
            <p class="text-gray-600">Enterprise Research Portal</p>
        </div>
        
        <form id="login-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="email" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="password" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <button type="submit" 
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                Sign In
            </button>
        </form>
        
        <div id="auth-error" class="mt-4 text-red-600 text-sm text-center hidden"></div>
        
        <p class="mt-6 text-center text-sm text-gray-500">
            Contact admin if you don't have an account
        </p>
    </div>
</div>

<!-- Main Dashboard Layout -->
<div id="dashboard" class="hidden min-h-screen">
    <!-- Top Navigation -->
    <nav class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center sticky top-0 z-30">
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-flask text-white"></i>
                </div>
                <span class="text-xl font-bold text-gray-800">Research Craft</span>
            </div>
            
            <div class="hidden md:flex items-center space-x-1">
                <span class="text-xs text-gray-500">Current Role:</span>
                <span id="current-role-badge" class="status-badge bg-blue-100 text-blue-800"></span>
            </div>
        </div>
        
        <div class="flex items-center space-x-4">
            <div class="hidden md:block text-right">
                <p class="text-xs text-gray-500">Organization</p>
                <p id="org-name" class="text-sm font-semibold text-gray-800">Loading...</p>
            </div>
            
            <div class="relative">
                <button id="notifications-btn" class="p-2 rounded-full hover:bg-gray-100 relative">
                    <i class="fas fa-bell text-gray-600"></i>
                    <span id="notification-count" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
                </button>
            </div>
            
            <button id="logout-btn" 
                    class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-100 transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="flex">
        <!-- Sidebar -->
        <aside class="hidden md:flex w-64 bg-gray-900 text-white flex-col h-[calc(100vh-68px)] sticky top-[68px]">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-3 mb-4">
                    <div id="user-avatar" class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-bold">
                        U
                    </div>
                    <div>
                        <h3 id="user-name" class="font-semibold">Loading...</h3>
                        <p id="user-email" class="text-xs text-gray-400 truncate">user@example.com</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span id="user-role" class="status-badge bg-blue-600 text-white"></span>
                    <span id="user-org" class="text-xs text-gray-400">ORG-0000</span>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto" id="sidebar-nav">
                <!-- Navigation will be populated dynamically -->
            </nav>
            
            <div class="p-4 border-t border-gray-800">
                <div class="text-xs text-gray-400 mb-2">Quick Stats</div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-gray-800 rounded p-2">
                        <div class="text-xs text-gray-400">Orders</div>
                        <div id="stats-orders" class="font-bold">0</div>
                    </div>
                    <div class="bg-gray-800 rounded p-2">
                        <div class="text-xs text-gray-400">Tickets</div>
                        <div id="stats-tickets" class="font-bold">0</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 flex justify-around z-40">
            <button data-view="dashboard" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600">
                <i class="fas fa-chart-bar text-lg"></i>
                <span class="text-xs mt-1">Dashboard</span>
            </button>
            <button data-view="orders" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600">
                <i class="fas fa-tasks text-lg"></i>
                <span class="text-xs mt-1">Orders</span>
            </button>
            <button data-view="inbox" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600">
                <i class="fas fa-inbox text-lg"></i>
                <span class="text-xs mt-1">Inbox</span>
            </button>
            <button data-view="payments" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600">
                <i class="fas fa-credit-card text-lg"></i>
                <span class="text-xs mt-1">Payments</span>
            </button>
            <button data-view="support" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600">
                <i class="fas fa-headset text-lg"></i>
                <span class="text-xs mt-1">Support</span>
            </button>
        </nav>
        
        <!-- Main Content Area -->
        <main class="flex-1 p-4 md:p-6 overflow-y-auto min-h-[calc(100vh-68px)] pb-20 md:pb-6">
            <div id="content-area">
                <!-- Content will be loaded here dynamically -->
            </div>
        </main>
    </div>
</div>

<!-- Modals -->

<!-- Lead Creation Modal (Sales Team) -->
<div id="lead-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800">Add New Lead</h3>
            <button onclick="closeModal('lead-modal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="lead-form" class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Client Name *</label>
                    <input type="text" name="clientName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input type="email" name="email" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Source</label>
                    <select name="source" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="Website">Website</option>
                        <option value="Referral">Referral</option>
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="Conference">Conference</option>
                        <option value="Cold Call">Cold Call</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Demand Level</label>
                    <select name="demandLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Title / Interest *</label>
                <input type="text" name="title" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea name="description" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Internal Notes</label>
                <textarea name="notes" rows="2" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-yellow-50 focus:ring-2 focus:ring-blue-500"
                          placeholder="Private notes visible only to sales team..."></textarea>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeModal('lead-modal')" 
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Lead
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Order Creation Modal (Sales Team) -->
<div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800">Create New Order</h3>
            <button onclick="closeModal('order-modal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="order-form" class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
            <input type="hidden" id="order-client-uid">
            <input type="hidden" id="order-lead-id">
            
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <p class="text-sm text-blue-800">
                    Creating order for: <span id="order-client-name" class="font-bold"></span>
                </p>
                <p class="text-xs text-blue-600" id="order-client-email"></p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Order Title *</label>
                <input type="text" id="order-title" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Agreed Price ($) *</label>
                    <input type="number" id="order-price" required min="0" step="0.01"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
                    <input type="date" id="order-deadline" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Scope Description *</label>
                <textarea id="order-description" rows="4" required 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assigned Agent</label>
                <select id="order-agent" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">Select an agent...</option>
                </select>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeModal('order-modal')" 
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Create Order
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Payment Creation Modal (Agent) -->
<div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800">Create Payment</h3>
            <button onclick="closeModal('payment-modal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="payment-form" class="p-6 space-y-4">
            <input type="hidden" id="payment-order-id">
            
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-sm font-medium text-gray-800" id="payment-order-title"></p>
                <p class="text-xs text-gray-500">Order ID: <span id="payment-order-id-text"></span></p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Title *</label>
                <input type="text" id="payment-title" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                       placeholder="e.g., Initial Deposit, Phase 1 Payment, Final Payment">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Amount ($) *</label>
                    <input type="number" id="payment-amount" required min="0" step="0.01"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                    <input type="date" id="payment-due-date" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="payment-description" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                <p class="text-xs text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    Payment will be created with Pending status. Client can mark it as paid.
                </p>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeModal('payment-modal')" 
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Create Payment
                </button>
            </div>
        </form>
    </div>
</div>

<!-- QR Code Payment Modal -->
<div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800">Pay with UPI</h3>
            <button onclick="closeModal('qr-modal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="p-6">
            <div class="text-center mb-6">
                <p class="text-2xl font-bold text-gray-800 mb-1" id="qr-amount">$0.00</p>
                <p class="text-sm text-gray-600" id="qr-title"></p>
                <p class="text-xs text-gray-500 mt-1">Payment ID: <span id="qr-payment-id"></span></p>
            </div>
            
            <div class="flex justify-center mb-6">
                <div id="qrcode" class="bg-white p-4 border-2 border-gray-300 rounded-lg"></div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <p class="text-xs font-medium text-gray-700 mb-2">UPI Details:</p>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">UPI ID 1:</span>
                        <span class="font-mono text-sm font-bold text-gray-800">researchcraft@okicici</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">UPI ID 2:</span>
                        <span class="font-mono text-sm font-bold text-gray-800">researchcraft@axl</span>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <button onclick="markPaymentAsPaid()" 
                        class="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">
                    <i class="fas fa-check-circle mr-2"></i>Mark as Paid
                </button>
                <button onclick="closeModal('qr-modal')" 
                        class="w-full py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ticket Creation Modal (Client) -->
<div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800">Create Support Ticket</h3>
            <button onclick="closeModal('ticket-modal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="ticket-form" class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Order *</label>
                <select id="ticket-order-select" required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Loading orders...</option>
                </select>
            </div>
            
            <div id="order-preview" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-medium text-blue-800" id="preview-order-title"></p>
                        <p class="text-xs text-blue-600 mt-1">Price: $<span id="preview-order-price"></span></p>
                    </div>
                    <span id="preview-order-status" class="status-badge"></span>
                </div>
                <p class="text-sm text-blue-700 mt-2" id="preview-order-desc"></p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Subject *</label>
                <input type="text" id="ticket-subject" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                       placeholder="Brief description of the issue">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                <textarea id="ticket-description" rows="4" required 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="Detailed explanation of the issue..."></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                <select id="ticket-priority" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Urgent">Urgent</option>
                </select>
            </div>
            
            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                <p class="text-xs text-yellow-800">
                    <i class="fas fa-shield-alt mr-1"></i>
                    This ticket will be automatically secured with an access key. Support team can join directly.
                </p>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeModal('ticket-modal')" 
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    Create Ticket
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Ticket Details Modal -->
<div id="ticket-details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl w-[95vw] h-[90vh] flex flex-col">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold text-gray-800" id="ticket-modal-title"></h3>
                <p class="text-xs text-gray-500" id="ticket-modal-subtitle"></p>
            </div>
            <button onclick="closeModal('ticket-details-modal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Panel - Ticket Info & Files -->
            <div class="w-1/3 border-r border-gray-200 flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <span id="ticket-status-badge" class="status-badge"></span>
                        <div id="ticket-actions" class="space-x-2">
                            <!-- Actions will be populated dynamically -->
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <p class="text-xs text-gray-500">Created</p>
                            <p class="text-sm font-medium" id="ticket-created"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Priority</p>
                            <p class="text-sm font-medium" id="ticket-priority"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Access Key</p>
                            <p class="text-sm font-mono font-medium" id="ticket-access-key"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Related Order</p>
                            <p class="text-sm font-medium" id="ticket-order"></p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-b border-gray-200">
                    <h4 class="font-medium text-gray-700 mb-3">Participants</h4>
                    <div id="ticket-participants" class="space-y-2">
                        <!-- Participants will be populated dynamically -->
                    </div>
                </div>
                
                <div class="flex-1 p-4 overflow-y-auto">
                    <h4 class="font-medium text-gray-700 mb-3">Files</h4>
                    <div id="ticket-files" class="space-y-2">
                        <!-- Files will be populated dynamically -->
                    </div>
                    
                    <div class="mt-4">
                        <div class="dropzone p-4 text-center cursor-pointer" 
                             onclick="document.getElementById('ticket-file-input').click()"
                             id="ticket-dropzone">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Drop files here or click to upload</p>
                            <p class="text-xs text-gray-400 mt-1">Max file size: 10MB</p>
                        </div>
                        <input type="file" id="ticket-file-input" multiple class="hidden" 
                               onchange="handleTicketFileUpload(event)">
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Chat -->
            <div class="flex-1 flex flex-col">
                <div class="flex-1 p-4 overflow-y-auto" id="ticket-chat">
                    <!-- Chat messages will be populated here -->
                </div>
                
                <div class="p-4 border-t border-gray-200">
                    <div class="flex space-x-2">
                        <input type="text" id="ticket-message-input" 
                               placeholder="Type your message..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <button onclick="sendTicketMessage()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="mt-2 flex justify-between">
                        <button onclick="document.getElementById('ticket-chat-file-input').click()" 
                                class="text-sm text-gray-600 hover:text-gray-800">
                            <i class="fas fa-paperclip mr-1"></i>Attach File
                        </button>
                        <input type="file" id="ticket-chat-file-input" class="hidden" 
                               onchange="handleTicketChatFileUpload(event)">
                        
                        <div id="ticket-rating-section" class="hidden">
                            <span class="text-sm text-gray-600">Rate Support:</span>
                            <div class="inline-flex ml-2">
                                <!-- Rating stars will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal -->
<div id="file-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800">Upload File</h3>
            <button onclick="closeModal('file-upload-modal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="p-6">
            <div class="dropzone p-8 text-center cursor-pointer mb-4" 
                 onclick="document.getElementById('file-input').click()"
                 id="file-dropzone">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                <p class="text-sm text-gray-600">Drop files here or click to upload</p>
                <p class="text-xs text-gray-400 mt-1">Supports: PDF, DOC, XLS, Images (Max 10MB)</p>
            </div>
            <input type="file" id="file-input" multiple class="hidden" onchange="handleFileSelect(event)">
            
            <div id="upload-progress" class="hidden">
                <div class="mb-2 flex justify-between text-sm">
                    <span>Uploading...</span>
                    <span id="upload-percentage">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="upload-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            
            <div id="uploaded-files" class="space-y-2 mt-4 max-h-40 overflow-y-auto">
                <!-- Uploaded files list -->
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeModal('file-upload-modal')" 
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button id="save-files-btn" onclick="saveUploadedFiles()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Files
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notifications Panel -->
<div id="notifications-panel" class="fixed right-4 top-16 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-40 hidden">
    <div class="p-4 border-b border-gray-200">
        <h3 class="font-bold text-gray-800">Notifications</h3>
    </div>
    <div class="max-h-96 overflow-y-auto">
        <div id="notifications-list" class="p-2">
            <!-- Notifications will be populated here -->
        </div>
    </div>
</div>

<!-- Configuration Script -->
<script>
// ============================================
// CONFIGURATION SECTION - Replace with your actual credentials
// ============================================

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyBDeDc6pWhghXmGYg9QYQ3nVAGTpo1u5AM",
    authDomain: "research-craft.firebaseapp.com",
    projectId: "research-craft",
    storageBucket: "research-craft.firebasestorage.app",
    messagingSenderId: "284823836570",
    appId: "1:284823836570:web:fb0d93cdf92368525d8c23",
    measurementId: "G-6H5BS98612"
};

// Brevo Email API Key
const BREVO_API_KEY = "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";

// ============================================
// APPLICATION STATE
// ============================================

let currentUser = null;
let currentView = 'dashboard';
let currentOrder = null;
let currentTicket = null;
let unsubscribeCallbacks = [];
let notifications = [];

// ============================================
// FIREBASE INITIALIZATION
// ============================================

// Initialize Firebase
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
} catch (error) {
    console.error('Firebase initialization error:', error);
}

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ============================================
// AUTHENTICATION MANAGEMENT
// ============================================

// Check authentication state
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // User is signed in
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    ...userDoc.data()
                };
                showDashboard();
                setupRealtimeListeners();
                updateUserUI();
            } else {
                // User document doesn't exist
                await auth.signOut();
                showError('User data not found. Please contact administrator.');
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
            showError('Error loading user data. Please try again.');
        }
    } else {
        // No user is signed in
        showAuthScreen();
    }
});

// Login form handler
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('auth-error');
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
    }
});

// Logout handler
document.getElementById('logout-btn').addEventListener('click', () => {
    unsubscribeCallbacks.forEach(unsubscribe => unsubscribe());
    unsubscribeCallbacks = [];
    auth.signOut();
});

// ============================================
// UI MANAGEMENT
// ============================================

function showAuthScreen() {
    document.getElementById('loading-screen').classList.add('hidden');
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('dashboard').classList.add('hidden');
}

function showDashboard() {
    document.getElementById('loading-screen').classList.add('hidden');
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    loadView(currentView);
}

function updateUserUI() {
    if (!currentUser) return;
    
    // Update user info
    document.getElementById('user-name').textContent = currentUser.displayName || currentUser.email;
    document.getElementById('user-email').textContent = currentUser.email;
    document.getElementById('user-role').textContent = currentUser.role;
    document.getElementById('user-role').className = `status-badge ${getRoleBadgeClass(currentUser.role)}`;
    document.getElementById('current-role-badge').textContent = currentUser.role;
    document.getElementById('current-role-badge').className = `status-badge ${getRoleBadgeClass(currentUser.role)}`;
    document.getElementById('user-org').textContent = currentUser.orgId || 'ORG-0000';
    document.getElementById('org-name').textContent = currentUser.orgId || 'Organization';
    
    // Update avatar with initials
    const avatar = document.getElementById('user-avatar');
    if (currentUser.displayName) {
        avatar.textContent = currentUser.displayName.charAt(0).toUpperCase();
    }
    
    // Update sidebar navigation based on role
    updateSidebarNavigation();
}

function getRoleBadgeClass(role) {
    switch(role) {
        case 'Client': return 'bg-green-100 text-green-800';
        case 'Agent': return 'bg-blue-100 text-blue-800';
        case 'Sales Team': return 'bg-purple-100 text-purple-800';
        case 'Support Team': return 'bg-orange-100 text-orange-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function updateSidebarNavigation() {
    const nav = document.getElementById('sidebar-nav');
    nav.innerHTML = '';
    
    const navItems = [
        { id: 'dashboard', icon: 'fas fa-chart-bar', label: 'Dashboard', roles: ['Client', 'Agent', 'Sales Team', 'Support Team'] },
        { id: 'orders', icon: 'fas fa-tasks', label: 'Orders', roles: ['Client', 'Agent', 'Sales Team'] },
        { id: 'inbox', icon: 'fas fa-inbox', label: 'Inbox', roles: ['Client', 'Sales Team'] },
        { id: 'payments', icon: 'fas fa-credit-card', label: 'Payments', roles: ['Client', 'Agent'] },
        { id: 'support', icon: 'fas fa-headset', label: 'Support Tickets', roles: ['Client', 'Support Team'] }
    ];
    
    navItems.forEach(item => {
        if (item.roles.includes(currentUser.role)) {
            const button = document.createElement('button');
            button.className = `w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3 transition-colors ${currentView === item.id ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800 hover:text-white'}`;
            button.innerHTML = `
                <i class="${item.icon} w-5"></i>
                <span>${item.label}</span>
            `;
            button.addEventListener('click', () => loadView(item.id));
            nav.appendChild(button);
        }
    });
}

// ============================================
// VIEW LOADING SYSTEM
// ============================================

function loadView(viewName) {
    currentView = viewName;
    
    // Update active states
    document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
        btn.classList.toggle('text-blue-600', btn.dataset.view === viewName);
    });
    
    updateSidebarNavigation();
    
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';
    
    // Load the appropriate view
    setTimeout(() => {
        switch(viewName) {
            case 'dashboard':
                loadDashboardView();
                break;
            case 'orders':
                loadOrdersView();
                break;
            case 'inbox':
                loadInboxView();
                break;
            case 'payments':
                loadPaymentsView();
                break;
            case 'support':
                loadSupportView();
                break;
        }
    }, 300);
}

// Mobile navigation
document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
    btn.addEventListener('click', () => loadView(btn.dataset.view));
});

// ============================================
// DASHBOARD VIEW
// ============================================

async function loadDashboardView() {
    const contentArea = document.getElementById('content-area');
    
    try {
        // Fetch stats based on user role
        let stats = {
            orders: 0,
            pendingPayments: 0,
            openTickets: 0,
            totalRevenue: 0
        };
        
        if (currentUser.role === 'Client') {
            const ordersSnapshot = await db.collection('orders')
                .where('clientUid', '==', currentUser.uid)
                .get();
            stats.orders = ordersSnapshot.size;
            
            // Calculate pending payments
            for (const doc of ordersSnapshot.docs) {
                const paymentsSnapshot = await db.collection('payments')
                    .where('orderId', '==', doc.id)
                    .where('status', '==', 'pending')
                    .get();
                stats.pendingPayments += paymentsSnapshot.size;
            }
            
            const ticketsSnapshot = await db.collection('tickets')
                .where('clientUid', '==', currentUser.uid)
                .where('status', '==', 'open')
                .get();
            stats.openTickets = ticketsSnapshot.size;
        }
        
        // Update stats in sidebar
        document.getElementById('stats-orders').textContent = stats.orders;
        document.getElementById('stats-tickets').textContent = stats.openTickets;
        
        const html = `
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
                <p class="text-gray-600">Welcome back, ${currentUser.displayName || currentUser.email}</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i class="fas fa-tasks text-blue-600"></i>
                        </div>
                        <span class="text-sm text-gray-500">Active</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">${stats.orders}</h3>
                    <p class="text-sm text-gray-600">Orders</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                        <span class="text-sm text-gray-500">Pending</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">${stats.pendingPayments}</h3>
                    <p class="text-sm text-gray-600">Payments</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <i class="fas fa-headset text-red-600"></i>
                        </div>
                        <span class="text-sm text-gray-500">Open</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">${stats.openTickets}</h3>
                    <p class="text-sm text-gray-600">Tickets</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i class="fas fa-dollar-sign text-green-600"></i>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">$${stats.totalRevenue}</h3>
                    <p class="text-sm text-gray-600">Revenue</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-bold text-gray-800 mb-4">Recent Activity</h3>
                    <div id="recent-activity" class="space-y-4">
                        <!-- Recent activity will be loaded here -->
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-bold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        ${currentUser.role === 'Client' ? `
                            <button onclick="openTicketModal()" class="w-full text-left p-3 bg-purple-50 rounded-lg border border-purple-200 hover:bg-purple-100 transition-colors">
                                <i class="fas fa-plus text-purple-600 mr-2"></i>
                                Create Support Ticket
                            </button>
                        ` : ''}
                        
                        ${currentUser.role === 'Sales Team' ? `
                            <button onclick="openLeadModal()" class="w-full text-left p-3 bg-blue-50 rounded-lg border border-blue-200 hover:bg-blue-100 transition-colors">
                                <i class="fas fa-user-plus text-blue-600 mr-2"></i>
                                Add New Lead
                            </button>
                        ` : ''}
                        
                        ${currentUser.role === 'Agent' ? `
                            <button onclick="loadView('orders')" class="w-full text-left p-3 bg-green-50 rounded-lg border border-green-200 hover:bg-green-100 transition-colors">
                                <i class="fas fa-tasks text-green-600 mr-2"></i>
                                View Active Orders
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        contentArea.innerHTML = html;
        
        // Load recent activity
        loadRecentActivity();
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        contentArea.innerHTML = `
            <div class="text-center p-8">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <p class="text-gray-600">Error loading dashboard. Please try again.</p>
            </div>
        `;
    }
}

async function loadRecentActivity() {
    const container = document.getElementById('recent-activity');
    
    try {
        let activities = [];
        
        // Fetch recent activities based on user role
        if (currentUser.role === 'Client') {
            // Get recent orders, payments, and tickets
            const [ordersSnapshot, paymentsSnapshot, ticketsSnapshot] = await Promise.all([
                db.collection('orders')
                    .where('clientUid', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get(),
                db.collection('payments')
                    .where('clientUid', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get(),
                db.collection('tickets')
                    .where('clientUid', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get()
            ]);
            
            ordersSnapshot.forEach(doc => {
                const data = doc.data();
                activities.push({
                    id: doc.id,
                    type: 'order',
                    title: data.title,
                    status: data.status,
                    timestamp: data.createdAt,
                    icon: 'fas fa-tasks'
                });
            });
            
            paymentsSnapshot.forEach(doc => {
                const data = doc.data();
                activities.push({
                    id: doc.id,
                    type: 'payment',
                    title: data.title,
                    status: data.status,
                    amount: data.amount,
                    timestamp: data.createdAt,
                    icon: 'fas fa-credit-card'
                });
            });
            
            ticketsSnapshot.forEach(doc => {
                const data = doc.data();
                activities.push({
                    id: doc.id,
                    type: 'ticket',
                    title: data.subject,
                    status: data.status,
                    timestamp: data.createdAt,
                    icon: 'fas fa-headset'
                });
            });
        }
        
        // Sort by timestamp
        activities.sort((a, b) => b.timestamp - a.timestamp);
        
        // Display activities
        if (activities.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity</p>';
        } else {
            container.innerHTML = activities.map(activity => `
                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg">
                    <div class="p-2 rounded-lg ${getActivityColor(activity.type)}">
                        <i class="${activity.icon} ${getActivityIconColor(activity.type)}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${activity.title}</p>
                        <p class="text-xs text-gray-500">${formatTimestamp(activity.timestamp)}</p>
                    </div>
                    <span class="status-badge ${getStatusBadgeClass(activity.status)}">
                        ${activity.status}
                    </span>
                </div>
            `).join('');
        }
        
    } catch (error) {
        console.error('Error loading recent activity:', error);
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Error loading activity</p>';
    }
}

function getActivityColor(type) {
    switch(type) {
        case 'order': return 'bg-blue-50';
        case 'payment': return 'bg-green-50';
        case 'ticket': return 'bg-purple-50';
        default: return 'bg-gray-50';
    }
}

function getActivityIconColor(type) {
    switch(type) {
        case 'order': return 'text-blue-600';
        case 'payment': return 'text-green-600';
        case 'ticket': return 'text-purple-600';
        default: return 'text-gray-600';
    }
}

// ============================================
// ORDERS VIEW
// ============================================

async function loadOrdersView() {
    const contentArea = document.getElementById('content-area');
    
    try {
        let orders = [];
        let query = db.collection('orders');
        
        // Adjust query based on user role
        if (currentUser.role === 'Client') {
            query = query.where('clientUid', '==', currentUser.uid);
        } else if (currentUser.role === 'Agent') {
            query = query.where('agentUid', '==', currentUser.uid);
        }
        
        const snapshot = await query.orderBy('createdAt', 'desc').get();
        
        snapshot.forEach(doc => {
            orders.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        const html = `
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Orders</h1>
                    <p class="text-gray-600">Manage your research orders</p>
                </div>
                ${currentUser.role === 'Sales Team' ? `
                    <button onclick="loadView('inbox')" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-inbox mr-2"></i>Go to Inbox
                    </button>
                ` : ''}
            </div>
            
            ${orders.length === 0 ? `
                <div class="text-center py-12 bg-white rounded-xl shadow-sm border border-gray-200">
                    <i class="fas fa-tasks text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">No orders yet</h3>
                    <p class="text-gray-600 mb-4">${currentUser.role === 'Client' ? 'Contact sales team to create an order' : 'No orders found'}</p>
                </div>
            ` : `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${orders.map(order => `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow cursor-pointer"
                             onclick="viewOrder('${order.id}')">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <span class="text-xs font-mono text-gray-500">${order.id.substring(0, 8)}</span>
                                    <h3 class="font-bold text-gray-800 mt-1">${order.title}</h3>
                                </div>
                                <span class="status-badge ${getStatusBadgeClass(order.status)}">
                                    ${order.status}
                                </span>
                            </div>
                            
                            <p class="text-sm text-gray-600 mb-4 line-clamp-2">${order.description}</p>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Price:</span>
                                    <span class="font-semibold text-gray-800">$${order.price}</span>
                                </div>
                                
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Deadline:</span>
                                    <span class="font-medium ${isDeadlineApproaching(order.deadline) ? 'text-red-600' : 'text-gray-800'}">
                                        ${order.deadline ? new Date(order.deadline).toLocaleDateString() : 'Not set'}
                                    </span>
                                </div>
                                
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Progress:</span>
                                    <span class="font-medium text-gray-800">${order.progress || 0}%</span>
                                </div>
                                
                                ${currentUser.role === 'Agent' ? `
                                    <div class="pt-3 border-t border-gray-100">
                                        <button onclick="event.stopPropagation(); updateOrderProgress('${order.id}')" 
                                                class="w-full px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm hover:bg-blue-100">
                                            Update Progress
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
        `;
        
        contentArea.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading orders:', error);
        contentArea.innerHTML = `
            <div class="text-center p-8">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <p class="text-gray-600">Error loading orders. Please try again.</p>
            </div>
        `;
    }
}

function getStatusBadgeClass(status) {
    switch(status?.toLowerCase()) {
        case 'open':
        case 'pending': return 'status-open';
        case 'in progress':
        case 'progress': return 'status-progress';
        case 'review': return 'status-review';
        case 'completed': return 'status-completed';
        case 'closed': return 'status-closed';
        case 'paid': return 'status-paid';
        case 'verified': return 'status-verified';
        default: return 'status-open';
    }
}

function isDeadlineApproaching(deadline) {
    if (!deadline) return false;
    const deadlineDate = new Date(deadline);
    const today = new Date();
    const diffTime = deadlineDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays <= 3 && diffDays >= 0;
}

async function viewOrder(orderId) {
    try {
        const orderDoc = await db.collection('orders').doc(orderId).get();
        if (!orderDoc.exists) {
            showError('Order not found');
            return;
        }
        
        currentOrder = {
            id: orderDoc.id,
            ...orderDoc.data()
        };
        
        // Load order details in a modal or detailed view
        // This is a simplified version - you can expand this
        const modalHtml = `
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">${currentOrder.title}</h3>
                        <p class="text-xs text-gray-500">Order ID: ${currentOrder.id}</p>
                    </div>
                    <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-2">Description</h4>
                            <p class="text-gray-800">${currentOrder.description}</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm text-gray-600">Status</span>
                                    <span class="status-badge ${getStatusBadgeClass(currentOrder.status)}">
                                        ${currentOrder.status}
                                    </span>
                                </div>
                                
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm text-gray-600">Price</span>
                                    <span class="font-semibold">$${currentOrder.price}</span>
                                </div>
                                
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Deadline</span>
                                    <span class="font-medium">${currentOrder.deadline ? new Date(currentOrder.deadline).toLocaleDateString() : 'Not set'}</span>
                                </div>
                            </div>
                            
                            ${currentUser.role === 'Client' ? `
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <h4 class="font-medium text-blue-800 mb-2">Update Deadline</h4>
                                    <div class="flex space-x-2">
                                        <input type="date" id="new-deadline" 
                                               class="flex-1 px-3 py-2 border border-blue-300 rounded-lg">
                                        <button onclick="updateOrderDeadline('${currentOrder.id}')" 
                                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                            Update
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${currentUser.role === 'Agent' ? `
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h4 class="font-medium text-green-800 mb-2">Update Status</h4>
                                    <div class="flex space-x-2">
                                        <select id="new-status" class="flex-1 px-3 py-2 border border-green-300 rounded-lg">
                                            <option value="in progress">In Progress</option>
                                            <option value="review">Under Review</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                        <button onclick="updateOrderStatus('${currentOrder.id}')" 
                                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                            Update
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-6">
                        <h4 class="font-medium text-gray-700 mb-4">Payments</h4>
                        <div id="order-payments-list">
                            <!-- Payments will be loaded here -->
                        </div>
                        
                        ${currentUser.role === 'Agent' ? `
                            <button onclick="openPaymentModal('${currentOrder.id}')" 
                                    class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Add Payment
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        // Create and show modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        modal.id = 'order-details-modal';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);
        
        // Load payments
        await loadOrderPayments(currentOrder.id);
        
    } catch (error) {
        console.error('Error viewing order:', error);
        showError('Error loading order details');
    }
}

function closeOrderModal() {
    const modal = document.getElementById('order-details-modal');
    if (modal) {
        modal.remove();
    }
}

async function loadOrderPayments(orderId) {
    const container = document.getElementById('order-payments-list');
    if (!container) return;
    
    try {
        const snapshot = await db.collection('payments')
            .where('orderId', '==', orderId)
            .orderBy('createdAt', 'desc')
            .get();
        
        if (snapshot.empty) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No payments found</p>';
            return;
        }
        
        let html = '<div class="space-y-3">';
        snapshot.forEach(doc => {
            const payment = doc.data();
            html += `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h5 class="font-medium text-gray-800">${payment.title}</h5>
                            <p class="text-xs text-gray-500">${payment.id}</p>
                        </div>
                        <div class="text-right">
                            <span class="status-badge ${getStatusBadgeClass(payment.status)}">
                                ${payment.status}
                            </span>
                            <p class="text-lg font-bold text-gray-800 mt-1">$${payment.amount}</p>
                        </div>
                    </div>
                    
                    ${payment.description ? `
                        <p class="text-sm text-gray-600 mb-3">${payment.description}</p>
                    ` : ''}
                    
                    <div class="flex justify-between items-center pt-3 border-t border-gray-200">
                        <span class="text-xs text-gray-500">
                            Created: ${formatTimestamp(payment.createdAt)}
                        </span>
                        <div class="space-x-2">
                            ${payment.status === 'pending' && currentUser.role === 'Client' ? `
                                <button onclick="openQRPaymentModal('${doc.id}')" 
                                        class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                                    Pay Now
                                </button>
                            ` : ''}
                            
                            ${payment.status === 'paid' && currentUser.role === 'Agent' ? `
                                <button onclick="verifyPayment('${doc.id}')" 
                                        class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                    Verify
                                </button>
                            ` : ''}
                            
                            <button onclick="downloadInvoice('${doc.id}')" 
                                    class="px-3 py-1 border border-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-50">
                                <i class="fas fa-download mr-1"></i>Invoice
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading payments:', error);
        container.innerHTML = '<p class="text-red-500 text-center py-4">Error loading payments</p>';
    }
}

// ============================================
// INBOX VIEW (Sales Team & Client)
// ============================================

async function loadInboxView() {
    const contentArea = document.getElementById('content-area');
    
    if (currentUser.role === 'Sales Team') {
        // Sales Team Inbox - Leads Management
        try {
            const leadsSnapshot = await db.collection('leads')
                .orderBy('createdAt', 'desc')
                .get();
            
            const leads = [];
            leadsSnapshot.forEach(doc => {
                leads.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            const html = `
                <div class="mb-6 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Sales Inbox</h1>
                        <p class="text-gray-600">Manage leads and client conversations</p>
                    </div>
                    <button onclick="openLeadModal()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-user-plus mr-2"></i>Add Lead
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 divide-x divide-gray-200">
                        <!-- Left Panel - Leads List -->
                        <div class="md:col-span-1">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="font-medium text-gray-800">Leads</h3>
                            </div>
                            <div class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
                                ${leads.length === 0 ? `
                                    <div class="p-4 text-center text-gray-500">
                                        No leads found
                                    </div>
                                ` : leads.map(lead => `
                                    <div class="p-4 hover:bg-gray-50 cursor-pointer border-l-4 ${lead.status === 'converted' ? 'border-green-500' : 'border-blue-500'}"
                                         onclick="selectLead('${lead.id}')">
                                        <div class="flex justify-between items-start mb-1">
                                            <h4 class="font-medium text-gray-800">${lead.clientName}</h4>
                                            <span class="text-xs ${lead.demandLevel === 'High' ? 'text-red-600' : lead.demandLevel === 'Medium' ? 'text-yellow-600' : 'text-green-600'}">
                                                ${lead.demandLevel}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-600 truncate">${lead.title}</p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            ${new Date(lead.createdAt?.toDate()).toLocaleDateString()}
                                        </p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Right Panel - Lead Details & Chat -->
                        <div class="md:col-span-2">
                            <div id="lead-details" class="h-[600px] flex flex-col">
                                <div class="p-6 text-center text-gray-500">
                                    <i class="fas fa-comments text-3xl mb-3"></i>
                                    <p>Select a lead to view details and chat</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            contentArea.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading inbox:', error);
            contentArea.innerHTML = `
                <div class="text-center p-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <p class="text-gray-600">Error loading inbox. Please try again.</p>
                </div>
            `;
        }
    } else if (currentUser.role === 'Client') {
        // Client Inbox - Chat with Sales Team
        const html = `
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Inbox</h1>
                <p class="text-gray-600">Chat with sales team</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="text-center py-12">
                    <i class="fas fa-comments text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Contact Sales Team</h3>
                    <p class="text-gray-600 mb-4">Start a conversation to discuss your research needs</p>
                    <button onclick="startSalesChat()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Start New Conversation
                    </button>
                </div>
            </div>
        `;
        
        contentArea.innerHTML = html;
    }
}

function openLeadModal() {
    document.getElementById('lead-modal').classList.remove('hidden');
    document.getElementById('lead-form').reset();
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

// Lead form submission
document.getElementById('lead-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const leadData = {
        clientName: formData.get('clientName'),
        email: formData.get('email'),
        source: formData.get('source'),
        demandLevel: formData.get('demandLevel'),
        title: formData.get('title'),
        description: formData.get('description'),
        notes: formData.get('notes'),
        status: 'new',
        salesUid: currentUser.uid,
        salesName: currentUser.displayName,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection('leads').add(leadData);
        closeModal('lead-modal');
        showSuccess('Lead added successfully');
        loadInboxView(); // Refresh the view
    } catch (error) {
        console.error('Error adding lead:', error);
        showError('Error adding lead. Please try again.');
    }
});

async function selectLead(leadId) {
    try {
        const leadDoc = await db.collection('leads').doc(leadId).get();
        if (!leadDoc.exists) {
            showError('Lead not found');
            return;
        }
        
        const lead = leadDoc.data();
        const detailsContainer = document.getElementById('lead-details');
        
        // Check if client has been invited
        let clientStatus = '';
        let inviteButton = '';
        
        if (lead.clientUid) {
            clientStatus = '<span class="text-green-600"> Client Account Created</span>';
        } else {
            clientStatus = '<span class="text-yellow-600"> Not Invited Yet</span>';
            inviteButton = `
                <button onclick="inviteClientToPortal('${leadId}', '${lead.clientName}', '${lead.email}')" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-envelope mr-2"></i>Invite to Portal
                </button>
            `;
        }
        
        // Load chat messages
        const chatSnapshot = await db.collection('leadChats')
            .where('leadId', '==', leadId)
            .orderBy('timestamp', 'asc')
            .get();
        
        let chatMessages = '';
        chatSnapshot.forEach(doc => {
            const msg = doc.data();
            chatMessages += `
                <div class="flex ${msg.senderUid === currentUser.uid ? 'justify-end' : 'justify-start'} mb-3">
                    <div class="max-w-[70%]">
                        <div class="text-xs text-gray-500 mb-1">
                            ${msg.senderName}  ${formatTimestamp(msg.timestamp)}
                        </div>
                        <div class="${msg.senderUid === currentUser.uid ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none'} rounded-lg p-3">
                            ${msg.message}
                        </div>
                    </div>
                </div>
            `;
        });
        
        detailsContainer.innerHTML = `
            <div class="flex-1 flex flex-col">
                <!-- Lead Header -->
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-gray-800">${lead.clientName}</h3>
                            <p class="text-sm text-gray-600">${lead.email}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs ${lead.demandLevel === 'High' ? 'text-red-600' : lead.demandLevel === 'Medium' ? 'text-yellow-600' : 'text-green-600'}">
                                ${lead.demandLevel} Demand
                            </span>
                            <p class="text-xs text-gray-500 mt-1">${lead.source}</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h4 class="font-medium text-gray-700 mb-1">${lead.title}</h4>
                        <p class="text-sm text-gray-600">${lead.description}</p>
                    </div>
                    
                    <div class="flex justify-between items-center mt-4">
                        <div>
                            ${clientStatus}
                        </div>
                        <div class="space-x-2">
                            ${inviteButton}
                            <button onclick="createOrderFromLead('${leadId}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-file-invoice-dollar mr-2"></i>Create Order
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Area -->
                <div class="flex-1 p-4 overflow-y-auto" id="lead-chat-messages">
                    ${chatMessages}
                </div>
                
                <!-- Message Input -->
                <div class="p-4 border-t border-gray-200">
                    <div class="flex space-x-2">
                        <input type="text" id="lead-message-input" 
                               placeholder="Type a message..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <button onclick="sendLeadMessage('${leadId}')" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Scroll to bottom of chat
        const chatContainer = document.getElementById('lead-chat-messages');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
    } catch (error) {
        console.error('Error selecting lead:', error);
        showError('Error loading lead details');
    }
}

async function inviteClientToPortal(leadId, clientName, email) {
    try {
        // Generate username and password
        const username = 'user_' + Math.random().toString(36).substr(2, 8);
        const password = Math.random().toString(36).slice(-8) + 'A1!';
        
        // Create user in Firebase Auth
        const secondaryApp = firebase.initializeApp(firebaseConfig, "Invite_" + Date.now());
        const userCredential = await secondaryApp.auth().createUserWithEmailAndPassword(email, password);
        
        // Create user document
        await db.collection('users').doc(userCredential.user.uid).set({
            displayName: clientName,
            email: email,
            username: username,
            role: 'Client',
            orgId: currentUser.orgId || 'ORG-0000',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update lead with client UID
        await db.collection('leads').doc(leadId).update({
            clientUid: userCredential.user.uid,
            status: 'invited',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Send email with credentials
        await sendInvitationEmail(clientName, email, username, password);
        
        // Clean up secondary app
        await secondaryApp.delete();
        
        showSuccess('Client invited successfully! Credentials sent to email.');
        selectLead(leadId); // Refresh the view
        
    } catch (error) {
        console.error('Error inviting client:', error);
        showError('Error inviting client: ' + error.message);
    }
}

async function sendInvitationEmail(clientName, email, username, password) {
    try {
        const response = await fetch('https://api.brevo.com/v3/smtp/email', {
            method: 'POST',
            headers: {
                'api-key': BREVO_API_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sender: {
                    name: 'Research Craft',
                    email: 'noreply@researchcraft.com'
                },
                to: [{
                    email: email,
                    name: clientName
                }],
                subject: 'Welcome to Research Craft - Your Account Credentials',
                htmlContent: `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; color: white;">
                            <h1 style="margin: 0; font-size: 28px;">Research Craft</h1>
                            <p style="margin: 10px 0 0; opacity: 0.9;">Enterprise Research Portal</p>
                        </div>
                        
                        <div style="padding: 30px; background: white;">
                            <h2 style="color: #333; margin-top: 0;">Welcome ${clientName}!</h2>
                            <p style="color: #666; line-height: 1.6;">
                                Your account has been created on Research Craft. Here are your login credentials:
                            </p>
                            
                            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin: 20px 0;">
                                <table style="width: 100%;">
                                    <tr>
                                        <td style="padding: 8px 0; color: #666;">Login URL:</td>
                                        <td style="padding: 8px 0; font-weight: bold;">
                                            <a href="${window.location.origin}" style="color: #667eea; text-decoration: none;">
                                                ${window.location.origin}
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666;">Email:</td>
                                        <td style="padding: 8px 0; font-weight: bold;">${email}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666;">Username:</td>
                                        <td style="padding: 8px 0; font-weight: bold;">${username}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666;">Password:</td>
                                        <td style="padding: 8px 0; font-weight: bold;">${password}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="text-align: center; margin: 30px 0;">
                                <a href="${window.location.origin}" 
                                   style="display: inline-block; background: #667eea; color: white; padding: 12px 30px; 
                                          text-decoration: none; border-radius: 5px; font-weight: bold;">
                                    Login to Portal
                                </a>
                            </div>
                            
                            <div style="border-top: 1px solid #e9ecef; padding-top: 20px; color: #999; font-size: 12px;">
                                <p style="margin: 5px 0;">
                                    <strong>Security Note:</strong> Please change your password after first login.
                                </p>
                                <p style="margin: 5px 0;">
                                    For security reasons, do not share your credentials with anyone.
                                </p>
                            </div>
                        </div>
                    </div>
                `
            })
        });
        
        if (!response.ok) {
            throw new Error('Email sending failed');
        }
        
    } catch (error) {
        console.error('Error sending email:', error);
        throw error;
    }
}

function createOrderFromLead(leadId) {
    // This would open the order creation modal with pre-filled client info
    // For now, we'll just show a message
    showInfo('Order creation from lead would open here');
}

async function sendLeadMessage(leadId) {
    const input = document.getElementById('lead-message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    try {
        await db.collection('leadChats').add({
            leadId: leadId,
            senderUid: currentUser.uid,
            senderName: currentUser.displayName,
            senderRole: currentUser.role,
            message: message,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        input.value = '';
        selectLead(leadId); // Refresh chat
        
    } catch (error) {
        console.error('Error sending message:', error);
        showError('Error sending message');
    }
}

// ============================================
// PAYMENTS VIEW
// ============================================

async function loadPaymentsView() {
    const contentArea = document.getElementById('content-area');
    
    try {
        let payments = [];
        let query = db.collection('payments');
        
        if (currentUser.role === 'Client') {
            query = query.where('clientUid', '==', currentUser.uid);
        } else if (currentUser.role === 'Agent') {
            // Agents can see payments for orders they're assigned to
            const ordersSnapshot = await db.collection('orders')
                .where('agentUid', '==', currentUser.uid)
                .get();
            
            const orderIds = [];
            ordersSnapshot.forEach(doc => {
                orderIds.push(doc.id);
            });
            
            if (orderIds.length > 0) {
                query = query.where('orderId', 'in', orderIds);
            } else {
                // No orders assigned
                payments = [];
            }
        }
        
        const snapshot = await query.orderBy('createdAt', 'desc').get();
        snapshot.forEach(doc => {
            payments.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        const html = `
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Payments</h1>
                <p class="text-gray-600">Manage and track payments</p>
            </div>
            
            ${payments.length === 0 ? `
                <div class="text-center py-12 bg-white rounded-xl shadow-sm border border-gray-200">
                    <i class="fas fa-credit-card text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">No payments found</h3>
                    <p class="text-gray-600">${currentUser.role === 'Client' ? 'No payments required at the moment' : 'No payments to manage'}</p>
                </div>
            ` : `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Details</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${payments.map(payment => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4">
                                            <div>
                                                <h4 class="font-medium text-gray-800">${payment.title}</h4>
                                                ${payment.description ? `
                                                    <p class="text-sm text-gray-600 mt-1">${payment.description}</p>
                                                ` : ''}
                                                <p class="text-xs text-gray-500 mt-1">ID: ${payment.id.substring(0, 8)}</p>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-900">${payment.orderTitle || 'N/A'}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-lg font-bold text-gray-800">$${payment.amount}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="status-badge ${getStatusBadgeClass(payment.status)}">
                                                ${payment.status}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-900">
                                                ${payment.dueDate ? new Date(payment.dueDate).toLocaleDateString() : 'N/A'}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex space-x-2">
                                                ${payment.status === 'pending' && currentUser.role === 'Client' ? `
                                                    <button onclick="openQRPaymentModal('${payment.id}')" 
                                                            class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                                                        Pay
                                                    </button>
                                                ` : ''}
                                                
                                                ${payment.status === 'paid' && currentUser.role === 'Agent' ? `
                                                    <button onclick="verifyPayment('${payment.id}')" 
                                                            class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                                        Verify
                                                    </button>
                                                ` : ''}
                                                
                                                <button onclick="downloadInvoice('${payment.id}')" 
                                                        class="px-3 py-1 border border-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-50">
                                                    <i class="fas fa-download mr-1"></i>Invoice
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `}
        `;
        
        contentArea.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading payments:', error);
        contentArea.innerHTML = `
            <div class="text-center p-8">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <p class="text-gray-600">Error loading payments. Please try again.</p>
            </div>
        `;
    }
}

function openPaymentModal(orderId) {
    currentOrder = { id: orderId };
    document.getElementById('payment-modal').classList.remove('hidden');
    document.getElementById('payment-form').reset();
    document.getElementById('payment-order-id').value = orderId;
    
    // Load order details for display
    db.collection('orders').doc(orderId).get().then(doc => {
        if (doc.exists) {
            const order = doc.data();
            document.getElementById('payment-order-title').textContent = order.title;
            document.getElementById('payment-order-id-text').textContent = orderId.substring(0, 8);
        }
    });
}

// Payment form submission
document.getElementById('payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const paymentData = {
        orderId: document.getElementById('payment-order-id').value,
        title: document.getElementById('payment-title').value,
        amount: parseFloat(document.getElementById('payment-amount').value),
        description: document.getElementById('payment-description').value,
        dueDate: document.getElementById('payment-due-date').value,
        status: 'pending',
        clientUid: currentUser.role === 'Agent' ? await getOrderClientUid(document.getElementById('payment-order-id').value) : currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection('payments').add(paymentData);
        closeModal('payment-modal');
        showSuccess('Payment created successfully');
        loadView('payments'); // Refresh payments view
    } catch (error) {
        console.error('Error creating payment:', error);
        showError('Error creating payment. Please try again.');
    }
});

async function getOrderClientUid(orderId) {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    return orderDoc.exists ? orderDoc.data().clientUid : null;
}

function openQRPaymentModal(paymentId) {
    db.collection('payments').doc(paymentId).get().then(doc => {
        if (doc.exists) {
            const payment = doc.data();
            
            // Update modal content
            document.getElementById('qr-amount').textContent = `$${payment.amount}`;
            document.getElementById('qr-title').textContent = payment.title;
            document.getElementById('qr-payment-id').textContent = paymentId.substring(0, 8);
            
            // Generate QR code
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            // Create UPI payment URL
            const upiUrl = `upi://pay?pa=researchcraft@okicici&pn=Research Craft&am=${payment.amount}&cu=INR&tn=Payment for ${payment.title}`;
            
            // Generate QR code
            QRCode.toCanvas(qrContainer, upiUrl, {
                width: 200,
                height: 200,
                margin: 1
            }, function(error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    qrContainer.innerHTML = '<p class="text-red-500">QR Code generation failed</p>';
                }
            });
            
            // Store current payment ID
            qrContainer.dataset.paymentId = paymentId;
            
            // Show modal
            document.getElementById('qr-modal').classList.remove('hidden');
        }
    });
}

async function markPaymentAsPaid() {
    const qrContainer = document.getElementById('qrcode');
    const paymentId = qrContainer.dataset.paymentId;
    
    if (!paymentId) return;
    
    try {
        await db.collection('payments').doc(paymentId).update({
            status: 'paid',
            paidAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeModal('qr-modal');
        showSuccess('Payment marked as paid. Waiting for agent verification.');
        loadView('payments'); // Refresh view
        
    } catch (error) {
        console.error('Error marking payment as paid:', error);
        showError('Error updating payment status');
    }
}

async function verifyPayment(paymentId) {
    if (!confirm('Are you sure you want to verify this payment?')) return;
    
    try {
        await db.collection('payments').doc(paymentId).update({
            status: 'verified',
            verifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
            verifiedBy: currentUser.uid,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showSuccess('Payment verified successfully');
        loadView('payments'); // Refresh view
        
    } catch (error) {
        console.error('Error verifying payment:', error);
        showError('Error verifying payment');
    }
}

function downloadInvoice(paymentId) {
    db.collection('payments').doc(paymentId).get().then(async doc => {
        if (doc.exists) {
            const payment = doc.data();
            const orderDoc = await db.collection('orders').doc(payment.orderId).get();
            const order = orderDoc.exists ? orderDoc.data() : {};
            
            // Create invoice using jsPDF
            const { jsPDF } = window.jspdf;
            const docPDF = new jsPDF();
            
            // Add logo and header
            docPDF.setFontSize(20);
            docPDF.text('Research Craft', 20, 20);
            docPDF.setFontSize(12);
            docPDF.setTextColor(100, 100, 100);
            docPDF.text('INVOICE', 20, 30);
            
            // Add invoice details
            docPDF.setFontSize(10);
            docPDF.text(`Invoice #: ${paymentId.substring(0, 8)}`, 20, 45);
            docPDF.text(`Date: ${new Date().toLocaleDateString()}`, 20, 50);
            docPDF.text(`Status: ${payment.status.toUpperCase()}`, 20, 55);
            
            // Add client details
            docPDF.text('Bill To:', 20, 70);
            docPDF.setFont(undefined, 'bold');
            docPDF.text(order.clientName || 'Client', 20, 75);
            docPDF.setFont(undefined, 'normal');
            
            // Add payment details table
            docPDF.autoTable({
                startY: 85,
                head: [['Description', 'Amount']],
                body: [
                    [payment.title, `$${payment.amount}`],
                    ['Total', `$${payment.amount}`]
                ],
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] }
            });
            
            // Add footer
            const pageHeight = docPDF.internal.pageSize.height;
            docPDF.setFontSize(8);
            docPDF.setTextColor(150, 150, 150);
            docPDF.text('Thank you for your business!', 20, pageHeight - 20);
            docPDF.text('Research Craft - Enterprise Research Solutions', 20, pageHeight - 15);
            
            // Save the PDF
            docPDF.save(`invoice-${paymentId.substring(0, 8)}.pdf`);
        }
    });
}

// ============================================
// SUPPORT TICKETS VIEW
// ============================================

async function loadSupportView() {
    const contentArea = document.getElementById('content-area');
    
    try {
        let tickets = [];
        let query = db.collection('tickets');
        
        if (currentUser.role === 'Client') {
            query = query.where('clientUid', '==', currentUser.uid);
        }
        // Support Team can see all tickets
        
        const snapshot = await query.orderBy('createdAt', 'desc').get();
        snapshot.forEach(doc => {
            tickets.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        const html = `
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Support Tickets</h1>
                    <p class="text-gray-600">${currentUser.role === 'Client' ? 'Get help with your orders' : 'Manage support requests'}</p>
                </div>
                
                ${currentUser.role === 'Client' ? `
                    <button onclick="openTicketModal()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-plus mr-2"></i>New Ticket
                    </button>
                ` : ''}
            </div>
            
            ${tickets.length === 0 ? `
                <div class="text-center py-12 bg-white rounded-xl shadow-sm border border-gray-200">
                    <i class="fas fa-headset text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">No tickets found</h3>
                    <p class="text-gray-600">
                        ${currentUser.role === 'Client' ? 'Create a ticket to get support' : 'No support requests yet'}
                    </p>
                </div>
            ` : `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${tickets.map(ticket => `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow cursor-pointer"
                             onclick="viewTicket('${ticket.id}')">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <span class="text-xs font-mono text-gray-500">${ticket.id.substring(0, 8)}</span>
                                    <h3 class="font-bold text-gray-800 mt-1 line-clamp-1">${ticket.subject}</h3>
                                </div>
                                <span class="status-badge ${getStatusBadgeClass(ticket.status)}">
                                    ${ticket.status}
                                </span>
                            </div>
                            
                            <p class="text-sm text-gray-600 mb-4 line-clamp-2">${ticket.description}</p>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Order:</span>
                                    <span class="font-medium text-gray-800">${ticket.orderTitle || 'N/A'}</span>
                                </div>
                                
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Priority:</span>
                                    <span class="font-medium ${ticket.priority === 'High' ? 'text-red-600' : ticket.priority === 'Medium' ? 'text-yellow-600' : 'text-green-600'}">
                                        ${ticket.priority}
                                    </span>
                                </div>
                                
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Created:</span>
                                    <span class="font-medium text-gray-800">
                                        ${formatTimestamp(ticket.createdAt)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
        `;
        
        contentArea.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading support tickets:', error);
        contentArea.innerHTML = `
            <div class="text-center p-8">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <p class="text-gray-600">Error loading tickets. Please try again.</p>
            </div>
        `;
    }
}

function openTicketModal() {
    // Clear and reset form
    document.getElementById('ticket-form').reset();
    document.getElementById('order-preview').classList.add('hidden');
    
    // Load client's orders
    loadClientOrdersForTicket();
    
    document.getElementById('ticket-modal').classList.remove('hidden');
}

async function loadClientOrdersForTicket() {
    const select = document.getElementById('ticket-order-select');
    select.innerHTML = '<option value="">Loading orders...</option>';
    
    try {
        const snapshot = await db.collection('orders')
            .where('clientUid', '==', currentUser.uid)
            .where('status', 'in', ['in progress', 'review', 'completed'])
            .get();
        
        select.innerHTML = '<option value="">Select an order (optional)</option>';
        snapshot.forEach(doc => {
            const order = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = `${order.title} - $${order.price}`;
            option.dataset.title = order.title;
            option.dataset.price = order.price;
            option.dataset.desc = order.description;
            option.dataset.status = order.status;
            select.appendChild(option);
        });
        
        if (snapshot.empty) {
            select.innerHTML = '<option value="">No active orders found</option>';
        }
        
    } catch (error) {
        console.error('Error loading orders:', error);
        select.innerHTML = '<option value="">Error loading orders</option>';
    }
}

// Ticket order select change handler
document.getElementById('ticket-order-select').addEventListener('change', function() {
    const preview = document.getElementById('order-preview');
    
    if (this.value) {
        const selectedOption = this.options[this.selectedIndex];
        document.getElementById('preview-order-title').textContent = selectedOption.dataset.title;
        document.getElementById('preview-order-price').textContent = selectedOption.dataset.price;
        document.getElementById('preview-order-desc').textContent = selectedOption.dataset.desc;
        document.getElementById('preview-order-status').textContent = selectedOption.dataset.status;
        document.getElementById('preview-order-status').className = `status-badge ${getStatusBadgeClass(selectedOption.dataset.status)}`;
        preview.classList.remove('hidden');
    } else {
        preview.classList.add('hidden');
    }
});

// Ticket form submission
document.getElementById('ticket-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const ticketData = {
        subject: document.getElementById('ticket-subject').value,
        description: document.getElementById('ticket-description').value,
        priority: document.getElementById('ticket-priority').value,
        orderId: document.getElementById('ticket-order-select').value || null,
        orderTitle: document.getElementById('ticket-order-select').value ? 
            document.getElementById('ticket-order-select').options[document.getElementById('ticket-order-select').selectedIndex].dataset.title : null,
        clientUid: currentUser.uid,
        clientName: currentUser.displayName || currentUser.email,
        status: 'open',
        accessKey: Math.random().toString(36).substr(2, 8).toUpperCase(), // 8-character access key
        participants: [currentUser.uid],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection('tickets').add(ticketData);
        closeModal('ticket-modal');
        showSuccess('Ticket created successfully! Access key: ' + ticketData.accessKey);
        loadSupportView(); // Refresh tickets view
        
    } catch (error) {
        console.error('Error creating ticket:', error);
        showError('Error creating ticket. Please try again.');
    }
});

async function viewTicket(ticketId) {
    try {
        const ticketDoc = await db.collection('tickets').doc(ticketId).get();
        if (!ticketDoc.exists) {
            showError('Ticket not found');
            return;
        }
        
        currentTicket = {
            id: ticketId,
            ...ticketDoc.data()
        };
        
        // Check if user can access this ticket
        if (currentUser.role === 'Client' && currentTicket.clientUid !== currentUser.uid) {
            showError('Access denied');
            return;
        }
        
        // Update modal with ticket details
        document.getElementById('ticket-modal-title').textContent = currentTicket.subject;
        document.getElementById('ticket-modal-subtitle').textContent = `Ticket ID: ${ticketId.substring(0, 8)}`;
        document.getElementById('ticket-status-badge').textContent = currentTicket.status;
        document.getElementById('ticket-status-badge').className = `status-badge ${getStatusBadgeClass(currentTicket.status)}`;
        document.getElementById('ticket-created').textContent = formatTimestamp(currentTicket.createdAt);
        document.getElementById('ticket-priority').textContent = currentTicket.priority;
        document.getElementById('ticket-access-key').textContent = currentTicket.accessKey;
        document.getElementById('ticket-order').textContent = currentTicket.orderTitle || 'Not linked to order';
        
        // Update actions based on user role and ticket status
        const actionsContainer = document.getElementById('ticket-actions');
        let actionsHtml = '';
        
        if (currentUser.role === 'Support Team') {
            if (currentTicket.status === 'open') {
                actionsHtml += `
                    <button onclick="closeTicket('${ticketId}')" 
                            class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                        Close
                    </button>
                `;
            } else {
                actionsHtml += `
                    <button onclick="reopenTicket('${ticketId}')" 
                            class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                        Reopen
                    </button>
                `;
            }
            
            actionsHtml += `
                <button onclick="deleteTicket('${ticketId}')" 
                        class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">
                    Delete
                </button>
            `;
        }
        
        if (currentTicket.status === 'closed' && !currentTicket.rating) {
            actionsHtml += `
                <button onclick="showRatingForm('${ticketId}')" 
                        class="px-3 py-1 bg-yellow-600 text-white text-sm rounded-lg hover:bg-yellow-700">
                    Rate
                </button>
            `;
        }
        
        actionsContainer.innerHTML = actionsHtml;
        
        // Load participants
        await loadTicketParticipants(ticketId);
        
        // Load files
        await loadTicketFiles(ticketId);
        
        // Load chat messages
        await loadTicketChat(ticketId);
        
        // Show modal
        document.getElementById('ticket-details-modal').classList.remove('hidden');
        
    } catch (error) {
        console.error('Error viewing ticket:', error);
        showError('Error loading ticket details');
    }
}

async function loadTicketParticipants(ticketId) {
    const container = document.getElementById('ticket-participants');
    
    try {
        // Get ticket to see current participants
        const ticketDoc = await db.collection('tickets').doc(ticketId).get();
        const ticket = ticketDoc.data();
        
        if (!ticket.participants || ticket.participants.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No participants</p>';
            return;
        }
        
        // Fetch user details for each participant
        let participantsHtml = '';
        for (const uid of ticket.participants) {
            const userDoc = await db.collection('users').doc(uid).get();
            if (userDoc.exists) {
                const user = userDoc.data();
                participantsHtml += `
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                            <span class="text-sm font-medium text-blue-600">
                                ${user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase()}
                            </span>
                        </div>
                        <div>
                            <p class="text-sm font-medium">${user.displayName || user.email}</p>
                            <p class="text-xs text-gray-500">${user.role}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        container.innerHTML = participantsHtml;
        
    } catch (error) {
        console.error('Error loading participants:', error);
        container.innerHTML = '<p class="text-red-500 text-sm">Error loading participants</p>';
    }
}

async function loadTicketFiles(ticketId) {
    const container = document.getElementById('ticket-files');
    
    try {
        const snapshot = await db.collection('ticketFiles')
            .where('ticketId', '==', ticketId)
            .orderBy('uploadedAt', 'desc')
            .get();
        
        if (snapshot.empty) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No files uploaded</p>';
            return;
        }
        
        let filesHtml = '';
        snapshot.forEach(doc => {
            const file = doc.data();
            filesHtml += `
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-file text-gray-400"></i>
                        <div>
                            <p class="text-sm font-medium truncate max-w-[150px]">${file.fileName}</p>
                            <p class="text-xs text-gray-500">${formatTimestamp(file.uploadedAt)}</p>
                        </div>
                    </div>
                    <a href="${file.url}" target="_blank" 
                       class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            `;
        });
        
        container.innerHTML = filesHtml;
        
    } catch (error) {
        console.error('Error loading files:', error);
        container.innerHTML = '<p class="text-red-500 text-sm">Error loading files</p>';
    }
}

async function loadTicketChat(ticketId) {
    const container = document.getElementById('ticket-chat');
    
    try {
        const snapshot = await db.collection('ticketChats')
            .where('ticketId', '==', ticketId)
            .orderBy('timestamp', 'asc')
            .get();
        
        let chatHtml = '';
        snapshot.forEach(doc => {
            const message = doc.data();
            const isCurrentUser = message.senderUid === currentUser.uid;
            
            chatHtml += `
                <div class="mb-4 ${isCurrentUser ? 'text-right' : ''}">
                    <div class="inline-block max-w-[70%]">
                        <div class="text-xs text-gray-500 mb-1 ${isCurrentUser ? 'text-right' : ''}">
                            ${message.senderName}  ${formatTimestamp(message.timestamp)}
                        </div>
                        <div class="${isCurrentUser ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none'} rounded-lg p-3">
                            ${message.message}
                            ${message.fileUrl ? `
                                <div class="mt-2">
                                    <a href="${message.fileUrl}" target="_blank" 
                                       class="inline-flex items-center text-sm ${isCurrentUser ? 'text-blue-200 hover:text-white' : 'text-blue-600 hover:text-blue-800'}">
                                        <i class="fas fa-paperclip mr-1"></i>
                                        ${message.fileName}
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = chatHtml;
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
        
    } catch (error) {
        console.error('Error loading chat:', error);
        container.innerHTML = '<p class="text-red-500">Error loading chat</p>';
    }
}

async function sendTicketMessage() {
    if (!currentTicket) return;
    
    const input = document.getElementById('ticket-message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    try {
        // Add sender to participants if not already
        if (!currentTicket.participants.includes(currentUser.uid)) {
            await db.collection('tickets').doc(currentTicket.id).update({
                participants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
        }
        
        // Save message
        await db.collection('ticketChats').add({
            ticketId: currentTicket.id,
            senderUid: currentUser.uid,
            senderName: currentUser.displayName || currentUser.email,
            senderRole: currentUser.role,
            message: message,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update ticket timestamp
        await db.collection('tickets').doc(currentTicket.id).update({
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        input.value = '';
        loadTicketChat(currentTicket.id); // Refresh chat
        
    } catch (error) {
        console.error('Error sending message:', error);
        showError('Error sending message');
    }
}

async function handleTicketChatFileUpload(event) {
    const file = event.target.files[0];
    if (!file || !currentTicket) return;
    
    // Check file size (10MB limit)
    if (file.size > 10 * 1024 * 1024) {
        showError('File size must be less than 10MB');
        return;
    }
    
    try {
        // Upload file to Firebase Storage
        const storageRef = storage.ref();
        const fileRef = storageRef.child(`ticket-chats/${currentTicket.id}/${Date.now()}_${file.name}`);
        const uploadTask = fileRef.put(file);
        
        uploadTask.on('state_changed',
            (snapshot) => {
                // Progress handling can be added here
            },
            (error) => {
                console.error('Upload error:', error);
                showError('Error uploading file');
            },
            async () => {
                // Get download URL
                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                
                // Save message with file
                await db.collection('ticketChats').add({
                    ticketId: currentTicket.id,
                    senderUid: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email,
                    senderRole: currentUser.role,
                    message: 'Shared a file',
                    fileName: file.name,
                    fileUrl: downloadURL,
                    fileSize: file.size,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update ticket
                await db.collection('tickets').doc(currentTicket.id).update({
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Refresh chat
                loadTicketChat(currentTicket.id);
                
                // Reset file input
                event.target.value = '';
            }
        );
        
    } catch (error) {
        console.error('Error handling file upload:', error);
        showError('Error uploading file');
    }
}

async function closeTicket(ticketId) {
    if (!confirm('Are you sure you want to close this ticket?')) return;
    
    try {
        await db.collection('tickets').doc(ticketId).update({
            status: 'closed',
            closedAt: firebase.firestore.FieldValue.serverTimestamp(),
            closedBy: currentUser.uid,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showSuccess('Ticket closed successfully');
        viewTicket(ticketId); // Refresh ticket view
        
    } catch (error) {
        console.error('Error closing ticket:', error);
        showError('Error closing ticket');
    }
}

async function reopenTicket(ticketId) {
    try {
        await db.collection('tickets').doc(ticketId).update({
            status: 'open',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showSuccess('Ticket reopened');
        viewTicket(ticketId); // Refresh ticket view
        
    } catch (error) {
        console.error('Error reopening ticket:', error);
        showError('Error reopening ticket');
    }
}

async function deleteTicket(ticketId) {
    if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) return;
    
    try {
        await db.collection('tickets').doc(ticketId).delete();
        
        // Also delete related chat messages and files (in production, you might want to archive instead)
        closeModal('ticket-details-modal');
        showSuccess('Ticket deleted successfully');
        loadSupportView(); // Refresh tickets list
        
    } catch (error) {
        console.error('Error deleting ticket:', error);
        showError('Error deleting ticket');
    }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function formatTimestamp(timestamp) {
    if (!timestamp) return 'N/A';
    
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function showError(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
    toast.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas fa-exclamation-circle"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
    toast.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showInfo(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
    toast.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas fa-info-circle"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Setup real-time listeners for notifications
function setupRealtimeListeners() {
    // Listen for new messages if user is Support Team
    if (currentUser.role === 'Support Team') {
        const ticketListener = db.collection('tickets')
            .where('status', '==', 'open')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const ticket = change.doc.data();
                        addNotification({
                            id: change.doc.id,
                            type: 'ticket',
                            title: 'New Support Ticket',
                            message: `${ticket.subject} - ${ticket.clientName}`,
                            timestamp: new Date()
                        });
                    }
                });
            });
        
        unsubscribeCallbacks.push(() => ticketListener());
    }
    
    // Listen for payment updates if user is Client
    if (currentUser.role === 'Client') {
        const paymentListener = db.collection('payments')
            .where('clientUid', '==', currentUser.uid)
            .where('status', 'in', ['paid', 'verified'])
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'modified') {
                        const payment = change.doc.data();
                        const oldStatus = change.doc._previousStatus || 'pending';
                        
                        if (payment.status === 'verified' && oldStatus !== 'verified') {
                            addNotification({
                                id: change.doc.id,
                                type: 'payment',
                                title: 'Payment Verified',
                                message: `Payment for ${payment.title} has been verified`,
                                timestamp: new Date()
                            });
                        }
                    }
                });
            });
        
        unsubscribeCallbacks.push(() => paymentListener());
    }
    
    // Listen for order updates
    const orderListener = db.collection('orders')
        .where(currentUser.role === 'Client' ? 'clientUid' : 'agentUid', '==', currentUser.uid)
        .where('status', 'in', ['in progress', 'review', 'completed'])
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'modified') {
                    const order = change.doc.data();
                    const oldStatus = change.doc._previousStatus || 'open';
                    
                    if (order.status === 'completed' && oldStatus !== 'completed') {
                        addNotification({
                            id: change.doc.id,
                            type: 'order',
                            title: 'Order Completed',
                            message: `${order.title} has been completed`,
                            timestamp: new Date()
                        });
                    }
                }
            });
        });
    
    unsubscribeCallbacks.push(() => orderListener());
}

function addNotification(notification) {
    notifications.unshift(notification);
    updateNotificationUI();
}

function updateNotificationUI() {
    const countElement = document.getElementById('notification-count');
    const listElement = document.getElementById('notifications-list');
    
    if (notifications.length > 0) {
        countElement.textContent = notifications.length > 99 ? '99+' : notifications.length;
        countElement.classList.remove('hidden');
        
        // Update notifications list
        listElement.innerHTML = notifications.slice(0, 10).map(notif => `
            <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0">
                <div class="flex items-start space-x-3">
                    <div class="p-2 rounded-lg ${notif.type === 'ticket' ? 'bg-purple-100' : notif.type === 'payment' ? 'bg-green-100' : 'bg-blue-100'}">
                        <i class="fas ${notif.type === 'ticket' ? 'fa-headset' : notif.type === 'payment' ? 'fa-credit-card' : 'fa-tasks'} 
                           ${notif.type === 'ticket' ? 'text-purple-600' : notif.type === 'payment' ? 'text-green-600' : 'text-blue-600'}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${notif.title}</p>
                        <p class="text-xs text-gray-600">${notif.message}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatTimestamp(notif.timestamp)}</p>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        countElement.classList.add('hidden');
        listElement.innerHTML = `
            <div class="p-4 text-center text-gray-500">
                <i class="fas fa-bell-slash text-2xl mb-2"></i>
                <p>No notifications</p>
            </div>
        `;
    }
}

// Toggle notifications panel
document.getElementById('notifications-btn').addEventListener('click', (e) => {
    e.stopPropagation();
    const panel = document.getElementById('notifications-panel');
    panel.classList.toggle('hidden');
});

// Close notifications panel when clicking outside
document.addEventListener('click', (e) => {
    const panel = document.getElementById('notifications-panel');
    const btn = document.getElementById('notifications-btn');
    
    if (!panel.contains(e.target) && !btn.contains(e.target)) {
        panel.classList.add('hidden');
    }
});

// ============================================
// FILE UPLOAD HANDLERS
// ============================================

function handleFileSelect(event) {
    const files = event.target.files;
    const dropzone = document.getElementById('file-dropzone');
    const progress = document.getElementById('upload-progress');
    const uploadedFiles = document.getElementById('uploaded-files');
    
    // Reset
    uploadedFiles.innerHTML = '';
    progress.classList.add('hidden');
    
    if (files.length === 0) return;
    
    // Show selected files
    for (const file of files) {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
        fileItem.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas fa-file text-gray-400"></i>
                <span class="text-sm truncate max-w-[200px]">${file.name}</span>
            </div>
            <span class="text-xs text-gray-500">${formatFileSize(file.size)}</span>
        `;
        uploadedFiles.appendChild(fileItem);
    }
    
    // Show save button
    document.getElementById('save-files-btn').disabled = false;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ============================================
// DRAG AND DROP HANDLERS
// ============================================

// Add drag and drop handlers for file uploads
document.addEventListener('DOMContentLoaded', () => {
    const dropzones = document.querySelectorAll('.dropzone');
    
    dropzones.forEach(dropzone => {
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Trigger file input
                const fileInput = dropzone.nextElementSibling;
                if (fileInput && fileInput.type === 'file') {
                    fileInput.files = files;
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }
        });
    });
});

// ============================================
// INITIALIZATION
// ============================================

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    // Check if user is already logged in
    const user = auth.currentUser;
    if (user) {
        // User is already logged in, fetch user data
        db.collection('users').doc(user.uid).get().then(doc => {
            if (doc.exists) {
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    ...doc.data()
                };
                showDashboard();
                setupRealtimeListeners();
                updateUserUI();
            } else {
                showAuthScreen();
            }
        });
    } else {
        // Show auth screen after a brief delay
        setTimeout(() => {
            document.getElementById('loading-screen').classList.add('hidden');
            showAuthScreen();
        }, 1000);
    }
});

// ============================================
// ADDITIONAL FUNCTIONS FOR COMPLETENESS
// ============================================

// These functions would be implemented based on the specific requirements

async function updateOrderStatus(orderId) {
    const newStatus = document.getElementById('new-status').value;
    if (!newStatus) return;
    
    try {
        await db.collection('orders').doc(orderId).update({
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showSuccess('Order status updated');
        viewOrder(orderId); // Refresh order view
        
    } catch (error) {
        console.error('Error updating order status:', error);
        showError('Error updating order status');
    }
}

async function updateOrderDeadline(orderId) {
    const newDeadline = document.getElementById('new-deadline').value;
    if (!newDeadline) return;
    
    try {
        await db.collection('orders').doc(orderId).update({
            deadline: newDeadline,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showSuccess('Order deadline updated');
        viewOrder(orderId); // Refresh order view
        
    } catch (error) {
        console.error('Error updating order deadline:', error);
        showError('Error updating order deadline');
    }
}

async function updateOrderProgress(orderId) {
    const progress = prompt('Enter progress percentage (0-100):');
    if (progress === null) return;
    
    const progressNum = parseInt(progress);
    if (isNaN(progressNum) || progressNum < 0 || progressNum > 100) {
        showError('Please enter a valid percentage between 0 and 100');
        return;
    }
    
    try {
        await db.collection('orders').doc(orderId).update({
            progress: progressNum,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showSuccess('Order progress updated');
        loadView('orders'); // Refresh orders view
        
    } catch (error) {
        console.error('Error updating order progress:', error);
        showError('Error updating order progress');
    }
}

function startSalesChat() {
    // This would open a chat interface with sales team
    showInfo('Starting chat with sales team...');
    // In a full implementation, this would create a chat session
}

function showRatingForm(ticketId) {
    // This would show a rating form
    const rating = prompt('Rate the support experience (1-100):');
    if (rating === null) return;
    
    const ratingNum = parseInt(rating);
    if (isNaN(ratingNum) || ratingNum < 1 || ratingNum > 100) {
        showError('Please enter a valid rating between 1 and 100');
        return;
    }
    
    // Save rating to ticket
    db.collection('tickets').doc(ticketId).update({
        rating: ratingNum,
        ratedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        showSuccess('Thank you for your rating!');
        viewTicket(ticketId); // Refresh ticket view
    }).catch(error => {
        console.error('Error saving rating:', error);
        showError('Error saving rating');
    });
}

// ============================================
// MOBILE MENU TOGGLE
// ============================================

// Add mobile menu toggle if needed
const mobileMenuButton = document.createElement('button');
mobileMenuButton.className = 'md:hidden p-2';
mobileMenuButton.innerHTML = '<i class="fas fa-bars text-xl text-gray-600"></i>';
mobileMenuButton.addEventListener('click', () => {
    const sidebar = document.querySelector('aside');
    sidebar.classList.toggle('hidden');
});

// Add to header if needed
// document.querySelector('nav').insertBefore(mobileMenuButton, document.querySelector('nav div:first-child'));

// ============================================
// ERROR BOUNDARY
// ============================================

// Global error handler
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    showError('An unexpected error occurred. Please refresh the page.');
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    showError('An error occurred. Please try again.');
});

</script>
</body>
</html>